{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "2722330707520123784"
    }
  },
  "parameters": {
    "customerName": {
      "type": "string",
      "metadata": {
        "description": "Customer name/identifier"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region"
      }
    },
    "deploymentTime": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-dd')]",
      "metadata": {
        "description": "Deployment timestamp"
      }
    }
  },
  "variables": {
    "workspaceName": "[format('{0}-sentinel-workspace', parameters('customerName'))]",
    "resourcePrefix": "[parameters('customerName')]",
    "retentionDays": 90,
    "workspaceSku": "PerGB2018",
    "defaultTags": {
      "Environment": "Production",
      "Project": "MSSP-Sentinel",
      "Customer": "[parameters('customerName')]",
      "ManagedBy": "MSSP",
      "DeploymentDate": "[parameters('deploymentTime')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[variables('workspaceName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('defaultTags')]",
      "properties": {
        "sku": {
          "name": "[variables('workspaceSku')]"
        },
        "retentionInDays": "[variables('retentionDays')]",
        "features": {
          "enableLogAccessUsingOnlyResourcePermissions": true
        },
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "Microsoft.OperationsManagement/solutions",
      "apiVersion": "2015-11-01-preview",
      "name": "[format('SecurityInsights({0})', variables('workspaceName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('defaultTags')]",
      "properties": {
        "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      },
      "plan": {
        "name": "[format('SecurityInsights({0})', variables('workspaceName'))]",
        "publisher": "Microsoft",
        "product": "OMSGallery/SecurityInsights",
        "promotionCode": ""
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/onboardingStates",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName'))]",
      "properties": {},
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[resourceId('Microsoft.OperationsManagement/solutions', format('SecurityInsights({0})', variables('workspaceName')))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/dataSources",
      "apiVersion": "2020-08-01",
      "name": "[format('{0}/{1}', variables('workspaceName'), 'AzureActivityLogs')]",
      "kind": "AzureActivityLog",
      "properties": {
        "linkedResourceId": "[format('/subscriptions/{0}/providers/microsoft.insights/eventtypes/management', subscription().subscriptionId)]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/AzureActiveDirectory', variables('workspaceName'))]",
      "kind": "AzureActiveDirectory",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "dataTypes": {
          "alerts": {
            "state": "enabled"
          },
          "signIns": {
            "state": "enabled"
          },
          "auditLogs": {
            "state": "enabled"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/MicrosoftThreatProtection', variables('workspaceName'))]",
      "kind": "MicrosoftThreatProtection",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "dataTypes": {
          "incidents": {
            "state": "enabled"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/AADIdentityProtection', variables('workspaceName'))]",
      "kind": "AzureActiveDirectoryIdentityProtection",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "dataTypes": {
          "alerts": {
            "state": "enabled"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/ThreatIntelligence', variables('workspaceName'))]",
      "kind": "ThreatIntelligence",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "dataTypes": {
          "indicators": {
            "state": "enabled"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/Office365', variables('workspaceName'))]",
      "kind": "Office365",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "dataTypes": {
          "exchange": {
            "state": "enabled"
          },
          "sharePoint": {
            "state": "enabled"
          },
          "teams": {
            "state": "enabled"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2021-09-01-preview",
      "name": "[format('{0}-SecurityEvents-DCR', variables('resourcePrefix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('defaultTags')]",
      "properties": {
        "description": "MSSP Security Events Collection via AMA",
        "dataSources": {
          "windowsEventLogs": [
            {
              "name": "SecurityEvents",
              "streams": [
                "Microsoft-SecurityEvent"
              ],
              "xPathQueries": [
                "Security!*[System[(EventID=4624 or EventID=4625 or EventID=4648 or EventID=4688 or EventID=4720 or EventID=4726 or EventID=4776 or EventID=4782 or EventID=4793)]]"
              ]
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
              "name": "SecurityEventsLA"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-SecurityEvent"
            ],
            "destinations": [
              "SecurityEventsLA"
            ]
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2021-09-01-preview",
      "name": "[format('{0}-Syslog-DCR', variables('resourcePrefix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('defaultTags')]",
      "properties": {
        "description": "MSSP Syslog Collection via AMA",
        "dataSources": {
          "syslog": [
            {
              "name": "SyslogData",
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "auth",
                "authpriv",
                "cron",
                "daemon",
                "kern",
                "local0",
                "local1",
                "local2",
                "local3",
                "local4",
                "local5",
                "local6",
                "local7",
                "lpr",
                "mail",
                "news",
                "syslog",
                "user",
                "uucp"
              ],
              "logLevels": [
                "Debug",
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ]
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
              "name": "SyslogLA"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-Syslog"
            ],
            "destinations": [
              "SyslogLA"
            ]
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/watchlists",
      "apiVersion": "2021-03-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('workspaceName'))]",
      "name": "[format('{0}/Microsoft.SecurityInsights/MSSP-ThreatIntel', variables('workspaceName'))]",
      "properties": {
        "displayName": "MSSP Threat Intelligence",
        "provider": "MSSP Security Team",
        "source": "Internal",
        "description": "High-risk indicators identified across MSSP customer base",
        "numberOfLinesToSkip": 0,
        "rawContent": "Indicator,Type,Description,Confidence,TLP\n192.0.2.100,IP,Known malware C2,High,GREEN\n203.0.113.50,IP,Suspicious scanning activity,Medium,GREEN\nmalware.example.com,Domain,Malicious domain,High,GREEN",
        "itemsSearchKey": "Indicator",
        "contentType": "text/csv"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.OperationalInsights/workspaces/providers/onboardingStates', split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[0], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[1], split(format('{0}/Microsoft.SecurityInsights/default', variables('workspaceName')), '/')[2])]"
      ]
    }
  ],
  "outputs": {
    "workspaceName": {
      "type": "string",
      "value": "[variables('workspaceName')]"
    },
    "workspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2021-06-01').customerId]"
    },
    "workspaceResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "sentinelPortalUrl": {
      "type": "string",
      "value": "[format('https://portal.azure.com/#@{0}/blade/Microsoft_Azure_Security_Insights/MainMenuBlade/0/subscriptions/{1}/resourceGroups/{2}/providers/Microsoft.OperationalInsights/workspaces/{3}', subscription().tenantId, subscription().subscriptionId, resourceGroup().name, variables('workspaceName'))]"
    },
    "securityEventsDCRId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}-SecurityEvents-DCR', variables('resourcePrefix')))]"
    },
    "syslogDCRId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}-Syslog-DCR', variables('resourcePrefix')))]"
    },
    "deploymentSummary": {
      "type": "object",
      "value": {
        "customer": "[parameters('customerName')]",
        "workspace": "[variables('workspaceName')]",
        "location": "[parameters('location')]",
        "dataConnectorsDeployed": 9,
        "infrastructureComplete": true,
        "nextSteps": [
          "Navigate to Sentinel Analytics Rules in the portal",
          "Use \"Rule templates\" to bulk-enable OOTB rules for enabled connectors",
          "Associate Security Events DCR with Windows VMs",
          "Associate Syslog DCR with Linux VMs",
          "Configure TAXII threat intelligence feeds"
        ]
      }
    }
  }
}